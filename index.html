<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GarmentFix - Apparel Maintenance System</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. FIXED: Switched to official Google CDN for reliable module loading -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js"
      }
    }
    </script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .card { border: 1px solid #ccc; box-shadow: none; }
            .print-break-inside { break-inside: avoid; }
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .scan-line {
            width: 100%;
            height: 2px;
            background: #ef4444;
            position: absolute;
            top: 0;
            left: 0;
            animation: scan 2s infinite;
        }
        @keyframes scan {
            0% { top: 0%; }
            50% { top: 100%; }
            100% { top: 0%; }
        }
        
        #error-display {
            display: none;
            padding: 20px;
            background: #fee2e2;
            color: #b91c1c;
            border: 1px solid #ef4444;
            margin: 20px;
            border-radius: 8px;
            font-family: monospace;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <!-- Error Display Container -->
    <div id="error-display"></div>
    <div id="root"></div>

    <!-- Global Error Handler to catch "White Screen" crashes -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const display = document.getElementById('error-display');
            display.style.display = 'block';
            display.innerHTML = `<strong>App Crash Detected:</strong><br>${message}<br><small>${source}:${lineno}</small>`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          QrCode, ClipboardList, Wrench, LayoutDashboard, PlusCircle, AlertTriangle, 
          CheckCircle, Factory, Printer, ScanLine, Clock, PlayCircle, CheckSquare, 
          Building, History, X, Wifi, Database, Trash2, Loader2, User, LogOut, 
          Lock, MapPin, Briefcase, UserCheck, UserX, RefreshCw, Hand, Activity, 
          Settings, Package, BarChart2, AlertOctagon, CalendarClock, TrendingUp,
          ShoppingBag, MessageSquare, Camera, HelpCircle,
          FileText, Calendar, Filter, Search, Edit
        } from 'lucide-react';
        import { initializeApp, getApps, getApp } from "firebase/app";
        import { getDatabase, ref, push, update, onValue, set, remove, get } from "firebase/database";

        // --- 1. CONFIGURATION & SERVICES ---
        const firebaseConfig = {
          apiKey: "AIzaSyBUbE6WtnWnHQsCul_5bDDPHz78jlaHCxs",
          authDomain: "apparel-maintenance.firebaseapp.com",
          databaseURL: "https://apparel-maintenance-default-rtdb.firebaseio.com",
          projectId: "apparel-maintenance",
          storageBucket: "apparel-maintenance.firebasestorage.app",
          messagingSenderId: "716246308986",
          appId: "1:716246308986:web:0f5f33db9c65ffba1543c3",
          measurementId: "G-4G0694Q22Z"
        };

        // Safety check for Firebase Init
        let app;
        try {
            if (getApps().length === 0) {
                app = initializeApp(firebaseConfig);
            } else {
                app = getApp();
            }
        } catch (err) {
            console.error("Firebase Init Error:", err);
        }
        
        const db = getDatabase(app);

        // API Layer
        const api = {
            reportIssue: (machineId, issue, priority, opName, opId) => {
                const ticketId = `#TKT-${Math.floor(1000 + Math.random() * 9000)}`;
                return update(ref(db, `machines/${machineId}`), { 
                    status: "Pending", issue, priority, ticketId,
                    reportedBy: `${opName} (${opId})` 
                });
            },
            startWork: (machineId, userId) => {
                update(ref(db, `machines/${machineId}`), { status: 'In Progress' });
                update(ref(db, `users/${userId}`), { status: 'Active', currentTask: machineId });
                push(ref(db, 'logs'), { machineId, action: 'Started Work', userId, timestamp: new Date().toISOString() });
            },
            completeWork: (machineId, userId, remarks, machine, partsUsedIds, partsList) => {
                update(ref(db, `machines/${machineId}`), { 
                    status: 'Running', assignedTo: null, issue: null, priority: null, ticketId: null, lastMaintenance: new Date().toISOString() 
                });
                update(ref(db, `users/${userId}`), { status: 'Available', currentTask: null });
                
                partsUsedIds.forEach(partId => {
                    const part = partsList.find(p => p.id === partId);
                    if(part) update(ref(db, `parts/${partId}`), { stock: (part.stock || 0) - 1, totalUsed: (part.totalUsed || 0) + 1 });
                });

                const usedPartNames = partsUsedIds.map(id => partsList.find(p => p.id === id)?.name).filter(Boolean);
                push(ref(db, 'logs'), { 
                    machineId, ticketId: machine?.ticketId, action: 'Fixed', userId, details: remarks, partsUsed: usedPartNames, timestamp: new Date().toISOString() 
                });
            },
            assignTech: (machineId, techId) => update(ref(db, `machines/${machineId}`), { assignedTo: techId }),
            selfAssign: (machineId, userId) => update(ref(db, `machines/${machineId}`), { assignedTo: userId }),
            updateStock: (id, change, currentStock) => update(ref(db, `parts/${id}`), { stock: currentStock + change }),
            requestPart: (machineId, partName, user) => push(ref(db, 'partRequests'), {
                techName: user.name, techId: user.id, machineId, partName, status: 'Pending', timestamp: new Date().toISOString()
            }),
            resolveRequest: (reqId) => remove(ref(db, `partRequests/${reqId}`))
        };

        // --- 2. CUSTOM HOOKS ---
        const useFactoryData = () => {
            const [data, setData] = useState({ users: [], buildings: [], floors: [], lines: [], machines: [], logs: [], parts: [], partRequests: [] });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) { setLoading(false); return; }
                const endpoints = ['users', 'buildings', 'floors', 'lines', 'machines', 'logs', 'parts', 'partRequests'];
                const unsubscribers = endpoints.map(endpoint => {
                    return onValue(ref(db, endpoint), (snapshot) => {
                        const val = snapshot.val();
                        const list = val ? Object.keys(val).map(key => ({id: key, ...val[key]})) : [];
                        setData(prev => ({ ...prev, [endpoint]: list }));
                        if(endpoint === 'machines') setLoading(false);
                    }, (error) => {
                        console.error(`Error loading ${endpoint}:`, error);
                        if(endpoint === 'machines') setLoading(false);
                    });
                });
                return () => unsubscribers.forEach(unsub => unsub && unsub());
            }, []);

            const maps = useMemo(() => ({
                floorsMap: data.floors.reduce((acc, f) => { (acc[f.buildingId] = acc[f.buildingId] || []).push(f); return acc; }, {}),
                linesMap: data.lines.reduce((acc, l) => { (acc[l.floorId] = acc[l.floorId] || []).push(l); return acc; }, {}),
                machinesMap: data.machines.reduce((acc, m) => { (acc[m.lineId] = acc[m.lineId] || []).push(m); return acc; }, {})
            }), [data.floors, data.lines, data.machines]);

            return { ...data, ...maps, loading };
        };

        // --- 3. UI COMPONENTS ---
        const LoadingOverlay = ({ message }) => (
          <div className="fixed inset-0 bg-slate-900/90 flex flex-col items-center justify-center z-[100] text-white backdrop-blur-sm">
            <Loader2 className="w-16 h-16 animate-spin text-blue-500 mb-4" />
            <h3 className="text-2xl font-bold">{message || "Processing..."}</h3>
          </div>
        );

        const Card = ({ children, className = "" }) => (
          <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className} card`}>
            {children}
          </div>
        );

        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false, size = "md", fullWidth = false }) => {
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700",
                secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200",
                danger: "bg-red-500 text-white hover:bg-red-600",
                success: "bg-green-600 text-white hover:bg-green-700",
                warning: "bg-yellow-500 text-white hover:bg-yellow-600",
                outline: "border border-slate-300 text-slate-600 hover:bg-slate-50"
            };
            const sizes = { sm: "px-2 py-1 text-xs", md: "px-4 py-2 text-sm", lg: "px-6 py-3 text-base" };
            return (
                <button onClick={onClick} disabled={disabled} className={`rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${variants[variant]} ${sizes[size]} ${fullWidth ? 'w-full' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}>
                    {children}
                </button>
            );
        };

        const Badge = ({ status, type = "status" }) => {
            const styles = {
                Running: "bg-green-100 text-green-800 border-green-200",
                Pending: "bg-red-100 text-red-800 border-red-200 animate-pulse",
                "In Progress": "bg-yellow-100 text-yellow-800 border-yellow-200",
                Available: "bg-emerald-100 text-emerald-800 border-emerald-200",
                Active: "bg-orange-100 text-orange-800 border-orange-200",
                Offline: "bg-slate-100 text-slate-500 border-slate-200",
                Low: "bg-blue-100 text-blue-800 border-blue-200",
                Normal: "bg-slate-100 text-slate-800 border-slate-200",
                Critical: "bg-red-600 text-white border-red-700 animate-pulse font-bold shadow-sm",
            };
            return <span className={`px-2 py-1 rounded-full text-xs font-bold border ${styles[status] || styles.Running}`}>{status}</span>;
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50 shrink-0">
                            <h3 className="font-bold text-lg">{title}</h3>
                            <button onClick={onClose}><X className="w-5 h-5 text-slate-500" /></button>
                        </div>
                        <div className="p-4 overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        // --- NEW: Universal Scanner Modal ---
        const ScannerModal = ({ isOpen, onClose, onScan, title = "Scan QR Code", machines }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[60] p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]">
                        <div className="p-4 bg-slate-900 text-white flex justify-between items-center">
                            <h3 className="font-bold text-lg flex items-center gap-2"><ScanLine className="w-5 h-5 text-blue-400"/> {title}</h3>
                            <button onClick={onClose}><X className="w-5 h-5" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 bg-slate-100 relative">
                            <div className="aspect-square bg-slate-800 rounded-xl mb-4 flex items-center justify-center relative overflow-hidden border-4 border-slate-300">
                                <Camera className="w-16 h-16 text-slate-600" />
                                <div className="scan-line"></div>
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <p className="text-white/50 text-sm font-mono bg-black/50 px-2 rounded">Simulating Camera Feed...</p>
                                </div>
                            </div>
                            <p className="text-center text-slate-500 text-xs mb-4 uppercase font-bold tracking-wider">Select a QR Code to simulate scan</p>
                            <div className="grid grid-cols-3 gap-2">
                                {machines.slice(0, 30).map(m => (
                                    <button key={m.id} onClick={() => onScan(m.id)} className="p-2 bg-white border border-slate-300 rounded hover:border-blue-500 hover:bg-blue-50 text-center transition-all">
                                        <QrCode className="w-6 h-6 mx-auto mb-1 text-slate-700" />
                                        <div className="text-[10px] font-bold truncate">{m.name}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 4. FEATURE VIEWS ---

        const LoginView = ({ onLogin, onReset, onOpenScanner, error }) => {
            const [creds, setCreds] = useState({username: "", password: ""});
            return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4">
                    <Card className="w-full max-w-md p-8 bg-white relative mb-4">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Factory className="w-8 h-8 text-blue-600" /></div>
                            <h1 className="text-2xl font-bold text-slate-800">GarmentFix</h1>
                            <p className="text-slate-500">Industrial Maintenance Platform</p>
                        </div>
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm font-bold border border-red-200">{error}</div>}
                        <form onSubmit={(e) => { e.preventDefault(); onLogin(creds.username, creds.password); }} className="space-y-4">
                            <input type="text" className="w-full p-3 border rounded-lg" placeholder="admin" value={creds.username} onChange={e => setCreds({...creds, username: e.target.value})} />
                            <input type="password" className="w-full p-3 border rounded-lg" placeholder="123" value={creds.password} onChange={e => setCreds({...creds, password: e.target.value})} />
                            <Button fullWidth size="lg">Sign In</Button>
                        </form>
                        <div className="mt-6 pt-4 border-t text-center text-xs text-slate-400">
                            <p className="mb-2">Master Key: <strong>admin</strong> / <strong>123</strong></p>
                            <button onClick={() => confirm("Reset all users?") && onReset()} className="text-red-400 hover:text-red-600 flex items-center gap-1 mx-auto mt-4"><Trash2 className="w-3 h-3" /> Emergency Reset</button>
                        </div>
                    </Card>
                    <button onClick={onOpenScanner} className="w-full max-w-md bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-xl flex items-center justify-center gap-3 shadow-lg transition-transform hover:scale-[1.02]">
                        <div className="bg-white/20 p-2 rounded-full"><QrCode className="w-6 h-6" /></div>
                        <div className="text-left"><div className="font-bold text-lg">Scan QR Code</div><div className="text-xs text-blue-200">Report Breakdown (No Login)</div></div>
                    </button>
                </div>
            );
        };

        const KioskView = ({ machines, onReport, onClose, initialMachineId }) => {
            const [selectedMachine, setSelectedMachine] = useState(initialMachineId ? machines.find(m => m.id === initialMachineId) : null);
            const [form, setForm] = useState({ issue: "", priority: "Normal", opName: "", opId: "" });

            const handleSubmit = () => {
                if(selectedMachine && form.issue && form.opName && form.opId) {
                    onReport(selectedMachine.id, form.issue, form.priority, form.opName, form.opId);
                    alert("Issue Reported Successfully!");
                    onClose();
                } else alert("Please fill in all fields.");
            };

            // If we have a machine, show form immediately
            if (selectedMachine) {
                return (
                    <div className="fixed inset-0 bg-slate-100 z-50 flex flex-col items-center justify-center p-4">
                        <div className="max-w-md w-full">
                            <Card className="p-6 shadow-xl border-t-4 border-t-blue-600">
                                <div className="flex justify-between items-start mb-6 border-b pb-4">
                                    <div>
                                        <h3 className="text-2xl font-bold text-slate-800">{selectedMachine.name}</h3>
                                        <p className="text-slate-500">{selectedMachine.type}</p>
                                    </div>
                                    <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X className="w-6 h-6"/></button>
                                </div>
                                <div className="space-y-4">
                                    <label className="block text-sm font-bold text-slate-700">Problem Description</label>
                                    <textarea className="w-full p-3 border rounded-lg h-24" placeholder="e.g. Needle broken..." value={form.issue} onChange={e => setForm({...form, issue: e.target.value})} />
                                    <label className="block text-sm font-bold text-slate-700">Priority</label>
                                    <div className="flex gap-2">{['Low', 'Normal', 'Critical'].map(p => (
                                        <button key={p} onClick={() => setForm({...form, priority: p})} className={`flex-1 py-2 rounded text-sm font-bold border ${form.priority === p ? 'bg-blue-600 text-white' : 'bg-white'}`}>{p}</button>
                                    ))}</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input className="w-full p-3 border rounded-lg" placeholder="Operator Name" value={form.opName} onChange={e => setForm({...form, opName: e.target.value})} />
                                        <input className="w-full p-3 border rounded-lg" placeholder="ID (OP-123)" value={form.opId} onChange={e => setForm({...form, opId: e.target.value})} />
                                    </div>
                                    <Button fullWidth size="lg" onClick={handleSubmit} disabled={!form.issue || !form.opName || !form.opId}>Submit Report</Button>
                                </div>
                            </Card>
                        </div>
                    </div>
                );
            }
            return null; 
        };

        const LiveMonitor = ({ machines, users, onAssign }) => {
            const pending = machines.filter(m => m.status === "Pending");
            const [modal, setModal] = useState(null);
            const [selTech, setSelTech] = useState("");

            return (
                <div className="space-y-6">
                    <Card className="p-4 bg-slate-800 text-white border-slate-700">
                        <h3 className="font-bold mb-3 flex items-center gap-2"><UserCheck className="w-4 h-4 text-emerald-400"/> Technician Status Board</h3>
                        <div className="flex gap-4 overflow-x-auto pb-2">
                            {users.filter(u => u.role === 'technician').map(tech => (
                                <div key={tech.id} className="bg-slate-700 p-2 rounded-lg min-w-[140px] flex flex-col items-center border border-slate-600">
                                    <div className="font-bold text-sm">{tech.name}</div>
                                    <div className="text-xs text-slate-400 mb-1">@{tech.username}</div>
                                    <Badge status={tech.status} />
                                    {tech.currentTask && <div className="mt-1 text-[10px] bg-slate-900 px-1 rounded text-orange-300">Busy</div>}
                                </div>
                            ))}
                        </div>
                    </Card>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Card className="p-4 border-l-4 border-l-red-500">
                            <h3 className="font-bold text-lg text-red-700 mb-4 flex items-center gap-2"><AlertTriangle className="w-5 h-5"/> Pending Issues ({pending.length})</h3>
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {pending.map(m => (
                                    <div key={m.id} className="flex justify-between items-center p-3 bg-red-50 rounded border border-red-100">
                                        <div>
                                            <div className="flex items-center gap-2 font-bold text-slate-800">{m.name} {m.priority && <Badge status={m.priority} type="priority"/>}</div>
                                            <div className="text-xs text-red-600">{m.issue}</div>
                                            {m.reportedBy && <div className="text-[10px] text-blue-600 mt-1">Rep: {m.reportedBy}</div>}
                                        </div>
                                        {!m.assignedTo ? <Button size="sm" onClick={() => setModal(m)}>Assign</Button> : <span className="text-xs bg-slate-100 px-2 py-1 rounded">Wait List</span>}
                                    </div>
                                ))}
                                {pending.length === 0 && <p className="text-slate-400 italic">No pending issues.</p>}
                            </div>
                        </Card>
                        <Card className="p-4 border-l-4 border-l-yellow-500">
                            <h3 className="font-bold text-lg text-yellow-700 mb-4 flex items-center gap-2"><Wrench className="w-5 h-5"/> Active Repairs</h3>
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {machines.filter(m => m.status === 'In Progress').map(m => (
                                    <div key={m.id} className="flex justify-between items-center p-3 bg-yellow-50 rounded border border-yellow-100">
                                        <div><div className="font-bold text-slate-800">{m.name}</div><div className="text-xs text-slate-500">Tech: {users.find(u => u.id === m.assignedTo)?.name || 'Unknown'}</div></div>
                                        <Badge status="In Progress" />
                                    </div>
                                ))}
                            </div>
                        </Card>
                    </div>
                    <Modal isOpen={!!modal} onClose={() => setModal(null)} title="Assign Technician">
                        <div className="space-y-4">
                            <p>Assigning to <strong>{modal?.name}</strong></p>
                            <select className="w-full p-2 border rounded" value={selTech} onChange={(e) => setSelTech(e.target.value)}>
                                <option value="">-- Choose Tech --</option>
                                {users.filter(u => u.role === 'technician' && u.status === 'Available').map(t => <option key={t.id} value={t.id}>{t.name} (Online)</option>)}
                            </select>
                            <Button fullWidth onClick={() => { onAssign(modal.id, selTech); setModal(null); setSelTech(""); }} disabled={!selTech}>Confirm</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const InventoryManager = ({ parts, partRequests, onAddPart, onDeletePart, onUpdateStock, onResolveRequest }) => {
            const [newPart, setNewPart] = useState({ name: "", stock: 0, minStock: 5 });
            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="space-y-6">
                        <Card className="p-6 h-fit">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><PlusCircle className="w-5 h-5"/> Add Part</h3>
                            <div className="space-y-3">
                                <input className="w-full p-2 border rounded" placeholder="Part Name" value={newPart.name} onChange={e => setNewPart({...newPart, name: e.target.value})} />
                                <input type="number" className="w-full p-2 border rounded" placeholder="Stock" value={newPart.stock} onChange={e => setNewPart({...newPart, stock: parseInt(e.target.value) || 0})} />
                                <Button fullWidth onClick={() => { if(newPart.name) { onAddPart(newPart); setNewPart({name: "", stock: 0, minStock: 5}); }}}>Add</Button>
                            </div>
                        </Card>
                        <Card className="p-6 h-fit border-t-4 border-t-orange-500">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><MessageSquare className="w-5 h-5"/> Requests</h3>
                            {partRequests.length === 0 ? <p className="text-slate-400 italic text-sm">No pending requests.</p> : (
                                <div className="space-y-3">
                                    {partRequests.map(req => (
                                        <div key={req.id} className="bg-orange-50 p-3 rounded border border-orange-200 text-sm">
                                            <div className="font-bold text-orange-900">{req.partName}</div>
                                            <div className="text-xs text-orange-700 mb-2">By: {req.techName}</div>
                                            <Button size="sm" variant="outline" className="w-full" onClick={() => onResolveRequest(req.id)}>Resolve</Button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </Card>
                    </div>
                    <Card className="p-6 lg:col-span-2">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Package className="w-5 h-5"/> Inventory</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50 border-b"><tr><th className="p-3">Name</th><th className="p-3 text-center">Used</th><th className="p-3">Stock</th><th className="p-3">Actions</th></tr></thead>
                                <tbody>
                                    {parts.map(part => (
                                        <tr key={part.id} className="border-b hover:bg-slate-50">
                                            <td className="p-3 font-medium">{part.name} {part.stock <= part.minStock && <span className="text-red-600 font-bold ml-2 text-xs">LOW</span>}</td>
                                            <td className="p-3 text-center text-slate-500">{part.totalUsed || 0}</td>
                                            <td className="p-3 flex items-center gap-2">
                                                <button onClick={() => onUpdateStock(part.id, -1, part.stock)} className="w-6 h-6 rounded bg-slate-200 hover:bg-slate-300">-</button>
                                                <span className="w-8 text-center font-bold">{part.stock}</span>
                                                <button onClick={() => onUpdateStock(part.id, 1, part.stock)} className="w-6 h-6 rounded bg-slate-200 hover:bg-slate-300">+</button>
                                            </td>
                                            <td className="p-3"><button onClick={() => onDeletePart(part.id)} className="text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4"/></button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        const AnalyticsDashboard = ({ logs, machines, parts, floors, lines, users, buildings }) => {
            const [reportType, setReportType] = useState('daily');
            const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [searchTerm, setSearchTerm] = useState("");

            // Filter Logs Logic
            const filteredLogs = logs.filter(log => {
                const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                const machine = machines.find(m => m.id === log.machineId);
                const machineName = machine ? machine.name.toLowerCase() : "";
                
                let dateMatch = true;
                if (reportType === 'daily') dateMatch = logDate === startDate;
                if (reportType === 'monthly') dateMatch = logDate.slice(0, 7) === startDate.slice(0, 7);
                if (reportType === 'custom') dateMatch = logDate >= startDate && logDate <= endDate;

                let machineMatch = true;
                if (searchTerm) {
                    machineMatch = machineName.includes(searchTerm.toLowerCase()) || 
                                   log.machineId.toLowerCase().includes(searchTerm.toLowerCase());
                }

                return dateMatch && machineMatch;
            }).reverse();

            const getMachineName = (id) => machines.find(m => m.id === id)?.name || "Unknown";
            const getUserName = (id) => users.find(u => u.id === id)?.name || "Unknown";
            
            const getMachineLocation = (machineId) => {
                const machine = machines.find(m => m.id === machineId);
                if (!machine) return "Unknown";
                const line = lines.find(l => l.id === machine.lineId);
                const floor = line ? floors.find(f => f.id === line.floorId) : null;
                const building = floor ? buildings.find(b => b.id === floor.buildingId) : null;
                return `${building?.name || '??'} > ${floor?.name || '??'} > ${line?.name || '??'}`;
            };

            // Selected Machine for Detail View
            const selectedMachine = searchTerm ? machines.find(m => m.name.toLowerCase().includes(searchTerm.toLowerCase()) || m.id === searchTerm) : null;
            
            const nextMaintenanceDate = (dateStr) => {
                if(!dateStr) return "Not Scheduled";
                const d = new Date(dateStr);
                d.setDate(d.getDate() + 30);
                return d.toLocaleDateString();
            };

            const totalFixes = logs.filter(l => l.action === 'Fixed').length;
            const partsUsedCount = logs.filter(l => l.partsUsed).reduce((acc, curr) => acc + curr.partsUsed.length, 0);
            const avgDowntime = totalFixes > 0 ? "45 mins" : "0 mins";

            return (
                <div className="space-y-6">
                    {/* Report Generator Controls */}
                    <Card className="p-6 bg-white border border-slate-200 no-print">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><FileText className="w-5 h-5"/> Generate Report</h3>
                        <div className="flex flex-wrap gap-4 items-end">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Report Type</label>
                                <select className="p-2 border rounded w-32" value={reportType} onChange={e => setReportType(e.target.value)}>
                                    <option value="daily">Daily</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Start Date</label>
                                <input type={reportType === 'monthly' ? 'month' : 'date'} className="p-2 border rounded" value={startDate} onChange={e => setStartDate(e.target.value)} />
                            </div>
                            {reportType === 'custom' && (
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">End Date</label>
                                    <input type="date" className="p-2 border rounded" value={endDate} onChange={e => setEndDate(e.target.value)} />
                                </div>
                            )}
                            <div className="flex-1 min-w-[200px]">
                                <label className="block text-xs font-bold text-slate-500 mb-1">Filter by Machine Name/ID</label>
                                <div className="relative">
                                    <Search className="absolute left-2 top-2.5 w-4 h-4 text-slate-400"/>
                                    <input className="w-full pl-8 p-2 border rounded" placeholder="Search Machine..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                </div>
                            </div>
                            <div className="ml-auto">
                                <Button onClick={() => window.print()}>Print / Save PDF</Button>
                            </div>
                        </div>
                    </Card>

                    {/* Overall Stats (Hidden if searching specific machine) */}
                    {!searchTerm && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <Card className="p-6 bg-purple-50 border-purple-100 flex items-center justify-between">
                                <div><p className="text-purple-900 font-bold">Total Repairs</p><h2 className="text-4xl font-bold text-purple-700">{totalFixes}</h2></div><CheckSquare className="w-10 h-10 text-purple-300" />
                            </Card>
                            <Card className="p-6 bg-orange-50 border-orange-100 flex items-center justify-between">
                                <div><p className="text-orange-900 font-bold">Parts Consumed</p><h2 className="text-4xl font-bold text-orange-700">{partsUsedCount}</h2></div><Package className="w-10 h-10 text-orange-300" />
                            </Card>
                            <Card className="p-6 bg-blue-50 border-blue-100 flex items-center justify-between">
                                <div><p className="text-blue-900 font-bold">Avg Downtime</p><h2 className="text-4xl font-bold text-blue-700">{avgDowntime}</h2></div><Clock className="w-10 h-10 text-blue-300" />
                            </Card>
                        </div>
                    )}

                    {/* Machine Specific Profile (Shown only when searching) */}
                    {selectedMachine && (
                        <Card className="p-6 border-t-4 border-t-blue-600 print-break-inside">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-900">{selectedMachine.name}</h2>
                                    <p className="text-slate-500">{selectedMachine.type} â€¢ ID: {selectedMachine.id}</p>
                                </div>
                                <Badge status={selectedMachine.status} />
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div className="bg-slate-50 p-4 rounded border">
                                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">Location</div>
                                    <div className="font-medium text-slate-800 flex items-center gap-2">
                                        <MapPin className="w-4 h-4 text-blue-500"/> {getMachineLocation(selectedMachine.id)}
                                    </div>
                                </div>
                                <div className="bg-slate-50 p-4 rounded border">
                                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">Maintenance Status</div>
                                    <div className="flex justify-between text-sm mb-1"><span>Last Service:</span> <span className="font-medium">{selectedMachine.lastMaintenance ? new Date(selectedMachine.lastMaintenance).toLocaleDateString() : 'Never'}</span></div>
                                    <div className="flex justify-between text-sm"><span>Next Due:</span> <span className="font-bold text-blue-600">{nextMaintenanceDate(selectedMachine.lastMaintenance)}</span></div>
                                </div>
                                <div className="bg-slate-50 p-4 rounded border">
                                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">Performance</div>
                                    <div className="text-sm">Total Breakdowns: <span className="font-bold">{filteredLogs.filter(l => l.action === 'Reported').length}</span></div>
                                    <div className="text-sm">Parts Replaced: <span className="font-bold">{filteredLogs.filter(l => l.partsUsed).length}</span></div>
                                </div>
                            </div>
                        </Card>
                    )}

                    {/* Detailed Report Table */}
                    <Card className="p-6">
                        <h3 className="font-bold text-lg mb-4">{searchTerm ? `Detailed History: ${selectedMachine?.name || searchTerm}` : `General Report (${reportType})`}</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-100 border-b">
                                    <tr>
                                        <th className="p-2">Date/Time</th>
                                        <th className="p-2">Ticket ID</th>
                                        {!searchTerm && <th className="p-2">Machine</th>}
                                        <th className="p-2">Action</th>
                                        <th className="p-2">Technician</th>
                                        <th className="p-2">Details/Parts</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredLogs.map((log, i) => (
                                        <tr key={i} className="border-b hover:bg-slate-50">
                                            <td className="p-2 text-xs">{new Date(log.timestamp).toLocaleString()}</td>
                                            <td className="p-2 font-mono text-xs">{log.ticketId || '-'}</td>
                                            {!searchTerm && <td className="p-2 font-bold">{getMachineName(log.machineId)}</td>}
                                            <td className="p-2"><span className={`px-2 py-1 rounded text-xs ${log.action === 'Fixed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{log.action}</span></td>
                                            <td className="p-2">{getUserName(log.userId)}</td>
                                            <td className="p-2 text-xs">
                                                {log.details && <div>{log.details}</div>}
                                                {log.partsUsed && <div className="text-orange-600 font-bold">Parts: {log.partsUsed.join(", ")}</div>}
                                            </td>
                                        </tr>
                                    ))}
                                    {filteredLogs.length === 0 && <tr><td colSpan="6" className="p-4 text-center text-slate-400">No records found for this period.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        const FactoryManager = ({ buildings, floorsMap, linesMap, machinesMap, onAddBuilding, onAddFloor, onAddLine, onAddMachine }) => {
            const [newBuilding, setNewBuilding] = useState("");
            const [newFloor, setNewFloor] = useState({ name: "", buildingId: "" });
            const [newLine, setNewLine] = useState({ name: "", floorId: "" });
            const [newMachine, setNewMachine] = useState({ name: "", type: "", year: "", lineId: "" });

            // --- QR Code Printing Logic (FIXED for Popup Blockers) ---
            const handlePrintQRs = (title, machinesList) => {
                if(!machinesList || machinesList.length === 0) return alert("No machines found to print.");
                
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert("Pop-up blocked! Please allow pop-ups for this site to print QR codes.");
                    return;
                }

                printWindow.document.write(`
                    <html>
                    <head>
                        <title>QR Codes - ${title}</title>
                        <style>
                            body { font-family: sans-serif; padding: 20px; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .grid { display: grid; grid-template-columns: repeat(auto-fill, 160px); gap: 15px; justify-content: center; }
                            .card { border: 2px solid #000; padding: 10px; text-align: center; page-break-inside: avoid; border-radius: 8px; width: 160px; height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
                            img { width: 100px; height: 100px; object-fit: contain; }
                            .name { font-weight: bold; font-size: 14px; margin-top: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
                            .id { font-size: 12px; color: #333; font-family: monospace; }
                            @media print {
                                .no-print { display: none; }
                                body { padding: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header no-print">
                            <h1>QR Codes: ${title}</h1>
                            <p>Total Machines: ${machinesList.length}</p>
                            <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; cursor: pointer; background: #2563eb; color: white; border: none; border-radius: 5px;">Print Labels</button>
                        </div>
                        <div class="grid">
                            ${machinesList.map(m => `
                                <div class="card">
                                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${m.id}" alt="${m.name}" />
                                    <div class="name">${m.name}</div>
                                    <div class="id">${m.id}</div>
                                </div>
                            `).join('')}
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            };

            const getMachinesForFloor = (fId) => {
                const lines = linesMap[fId] || [];
                return lines.flatMap(l => machinesMap[l.id] || []);
            };

            const getMachinesForBuilding = (bId) => {
                const floors = floorsMap[bId] || [];
                return floors.flatMap(f => getMachinesForFloor(f.id));
            };

            return (
                <div className="space-y-8">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <Card className="p-6 h-fit border-t-4 border-t-blue-500">
                            <h3 className="font-bold text-lg mb-4">Add Building</h3>
                            <div className="space-y-3">
                                <input className="w-full p-2 border rounded" placeholder="Name" value={newBuilding} onChange={e => setNewBuilding(e.target.value)} />
                                <Button onClick={() => { onAddBuilding(newBuilding); setNewBuilding(""); }} className="w-full">Add</Button>
                            </div>
                        </Card>
                        <Card className="p-6 h-fit border-t-4 border-t-indigo-500">
                            <h3 className="font-bold text-lg mb-4">Add Floor</h3>
                            <div className="space-y-3">
                                <select className="w-full p-2 border rounded" value={newFloor.buildingId} onChange={e => setNewFloor({...newFloor, buildingId: e.target.value})}>
                                    <option value="">Select Building</option>
                                    {buildings.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                </select>
                                <input className="w-full p-2 border rounded" placeholder="Floor" value={newFloor.name} onChange={e => setNewFloor({...newFloor, name: e.target.value})} />
                                <Button onClick={() => { onAddFloor(newFloor); setNewFloor({name: "", buildingId: ""}); }} className="w-full">Add</Button>
                            </div>
                        </Card>
                        <Card className="p-6 h-fit border-t-4 border-t-purple-500">
                            <h3 className="font-bold text-lg mb-4">Add Line</h3>
                            <div className="space-y-3">
                                <select className="w-full p-2 border rounded" value={newLine.floorId} onChange={e => setNewLine({...newLine, floorId: e.target.value})}>
                                    <option value="">Select Floor</option>
                                    {Object.keys(floorsMap).map(bId => (
                                        <optgroup key={bId} label={buildings.find(b=>b.id===bId)?.name}>
                                            {floorsMap[bId].map(f => <option key={f.id} value={f.id}>{f.name}</option>)}
                                        </optgroup>
                                    ))}
                                </select>
                                <input className="w-full p-2 border rounded" placeholder="Line Name" value={newLine.name} onChange={e => setNewLine({...newLine, name: e.target.value})} />
                                <Button onClick={() => { onAddLine(newLine); setNewLine({name: "", floorId: ""}); }} className="w-full">Add</Button>
                            </div>
                        </Card>
                        <Card className="p-6 h-fit border-t-4 border-t-pink-500">
                            <h3 className="font-bold text-lg mb-4">Add Machine</h3>
                            <div className="space-y-3">
                                <select className="w-full p-2 border rounded" value={newMachine.lineId} onChange={e => setNewMachine({...newMachine, lineId: e.target.value})}>
                                    <option value="">Select Line</option>
                                    {Object.keys(linesMap).map(fId => (
                                        linesMap[fId].map(l => <option key={l.id} value={l.id}>{l.name}</option>)
                                    ))}
                                </select>
                                <input className="w-full p-2 border rounded" placeholder="Machine ID" value={newMachine.name} onChange={e => setNewMachine({...newMachine, name: e.target.value})} />
                                <Button onClick={() => { onAddMachine(newMachine); setNewMachine({name: "", type: "", year: "", lineId: ""}); }} className="w-full">Add</Button>
                            </div>
                        </Card>
                    </div>
                    <h3 className="text-xl font-bold text-slate-800 border-t pt-8">Facility Overview</h3>
                    <div className="space-y-8">
                        {buildings.map(b => (
                            <div key={b.id} className="border-2 border-slate-300 rounded-xl p-4 bg-slate-50">
                                <div className="flex justify-between items-center mb-4 bg-white p-3 rounded shadow-sm">
                                    <h4 className="font-bold text-xl text-slate-800 flex items-center gap-2"><Building className="w-6 h-6 text-blue-600" /> {b.name}</h4>
                                    <Button size="sm" variant="outline" onClick={() => handlePrintQRs(b.name, getMachinesForBuilding(b.id))}><Printer className="w-4 h-4" /> Print Building QRs</Button>
                                </div>
                                <div className="pl-4 border-l-2 border-slate-300 space-y-6">
                                    {(floorsMap[b.id] || []).map(floor => (
                                        <div key={floor.id}>
                                            <div className="flex items-center gap-4 mb-3">
                                                <h5 className="font-bold text-lg text-slate-600 flex items-center gap-2"><LayoutDashboard className="w-4 h-4" /> {floor.name}</h5>
                                                <button onClick={() => handlePrintQRs(`${b.name} - ${floor.name}`, getMachinesForFloor(floor.id))} className="text-xs flex items-center gap-1 text-slate-500 hover:text-blue-600 border px-2 py-1 rounded bg-white"><Printer className="w-3 h-3"/> Print Floor QRs</button>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {(linesMap[floor.id] || []).map(line => (
                                                    <Card key={line.id} className="p-4">
                                                        <div className="flex justify-between items-center mb-3">
                                                            <h5 className="font-bold text-slate-800">{line.name}</h5>
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-xs text-slate-500 bg-slate-200 px-2 py-1 rounded">{(machinesMap[line.id] || []).length} M/C</span>
                                                                <button onClick={() => handlePrintQRs(`${floor.name} - ${line.name}`, machinesMap[line.id] || [])} title="Print Line QRs" className="p-1 hover:bg-blue-100 rounded text-slate-600"><Printer className="w-4 h-4"/></button>
                                                            </div>
                                                        </div>
                                                        <div className="space-y-2 max-h-40 overflow-y-auto">
                                                            {(machinesMap[line.id] || []).map(machine => (
                                                                <div key={machine.id} className="flex justify-between items-center p-2 bg-white rounded border text-sm shadow-sm">
                                                                    <span className="font-medium truncate w-24">{machine.name}</span>
                                                                    <div className="flex items-center gap-2">
                                                                        <button onClick={() => handlePrintQRs(machine.name, [machine])} title="Print QR" className="text-slate-400 hover:text-blue-600"><QrCode className="w-4 h-4"/></button>
                                                                        {machine.status === "Pending" && <AlertTriangle className="w-4 h-4 text-red-500" />}
                                                                        {machine.status === "In Progress" && <Wrench className="w-4 h-4 text-yellow-500" />}
                                                                        <div className={`w-3 h-3 rounded-full ${machine.status === 'Running' ? 'bg-green-500' : machine.status === 'Pending' ? 'bg-red-500 animate-pulse' : 'bg-yellow-500'}`}></div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </Card>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const TechnicianTaskBoard = ({ currentUser, machines, parts, onScanStart, onComplete, onSelfAssign, onRequestPart, logs, openScanner }) => {
            const priorityOrder = { "Critical": 0, "Normal": 1, "Low": 2 };
            const myTasks = machines.filter(m => m.assignedTo === currentUser.id && m.status === 'Pending').sort((a, b) => (priorityOrder[a.priority] || 1) - (priorityOrder[b.priority] || 1));
            const activeTask = machines.find(m => m.assignedTo === currentUser.id && m.status === 'In Progress');
            const unassignedTasks = machines.filter(m => !m.assignedTo && m.status === 'Pending');
            const [remarks, setRemarks] = useState("");
            const [selectedParts, setSelectedParts] = useState([]);
            const [requestPartName, setRequestPartName] = useState("");
            const [isRequestModalOpen, setIsRequestModalOpen] = useState(false);
            const [viewHistory, setViewHistory] = useState(false);
            const [completingTask, setCompletingTask] = useState(null); // Local state to hold task data after scan

            // Reset when active task changes or finishes
            useEffect(() => {
                if(!activeTask) setCompletingTask(null);
            }, [activeTask]);

            const togglePart = (partId) => {
                if(selectedParts.includes(partId)) setSelectedParts(selectedParts.filter(id => id !== partId));
                else setSelectedParts([...selectedParts, partId]);
            };

            const myHistory = logs.filter(l => l.userId === currentUser.id && l.action === 'Fixed').slice().reverse();

            // Handler for "Scan to Start"
            const handleScanToStart = (taskId) => {
                openScanner("Scan Machine QR to START", (scannedId) => {
                    if (scannedId === taskId) {
                        onScanStart(taskId);
                    } else {
                        alert(`Error: You scanned ${scannedId}, but the assigned task is for ${taskId}. Please scan the correct machine.`);
                    }
                });
            };

            // Handler for "Scan to Finish"
            const handleScanToFinish = (task) => {
                openScanner("Scan Machine QR to FINISH", (scannedId) => {
                    if (scannedId === task.id) {
                        setCompletingTask(task); // Reveal the completion form
                    } else {
                        alert(`Error: You scanned ${scannedId}. You are currently working on ${task.id}. Please scan the correct machine to finish.`);
                    }
                });
            };

            const handleFinalSubmit = () => {
                if(!remarks) return alert("Please enter details/remarks about the fix.");
                onComplete(activeTask.id, currentUser.id, remarks, activeTask, selectedParts, parts); 
                setSelectedParts([]); 
                setRemarks("");
                setCompletingTask(null);
            }

            if (viewHistory) {
                return (
                    <div className="max-w-xl mx-auto space-y-6 pb-20">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-slate-800">My Work History</h2>
                            <Button variant="secondary" onClick={() => setViewHistory(false)}>Back to Tasks</Button>
                        </div>
                        {myHistory.map((log, i) => (
                            <Card key={i} className="p-4">
                                <div className="font-bold text-slate-800">Fixed Machine ID: {log.machineId}</div>
                                <div className="text-xs text-slate-500">{new Date(log.timestamp).toLocaleString()}</div>
                                {log.details && <div className="mt-2 text-sm bg-slate-50 p-2 rounded">{log.details}</div>}
                            </Card>
                        ))}
                        {myHistory.length === 0 && <p className="text-slate-400 text-center">No history yet.</p>}
                    </div>
                );
            }

            return (
                <div className="max-w-xl mx-auto space-y-6 pb-20">
                    <div className="bg-slate-800 text-white p-6 rounded-xl shadow-lg flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold mb-1">Hello, {currentUser.name}</h2>
                            <div className="flex items-center gap-2 text-sm text-slate-300"><Badge status={currentUser.status} /><span>ID: {currentUser.username}</span></div>
                        </div>
                        <Button size="sm" variant="secondary" onClick={() => setViewHistory(true)}>My History</Button>
                    </div>
                    
                    {activeTask ? (
                        <Card className="p-6 border-l-4 border-l-orange-500 bg-orange-50">
                            <div className="flex justify-between items-start mb-4">
                                <div><h3 className="font-bold text-xl text-orange-800 flex items-center gap-2"><Wrench className="w-5 h-5"/> Work In Progress</h3><p className="text-slate-600">{activeTask.name} - {activeTask.issue}</p><div className="text-xs text-orange-400 mt-1 font-mono">{activeTask.ticketId}</div></div>
                                <div className="animate-pulse bg-orange-200 text-orange-800 px-3 py-1 rounded text-xs font-bold">TIMER ACTIVE</div>
                            </div>
                            
                            {!completingTask ? (
                                <div className="text-center py-8">
                                    <p className="text-slate-600 mb-4">Work is in progress. When you are done, scan the machine again to verify and submit report.</p>
                                    <Button fullWidth size="lg" variant="success" onClick={() => handleScanToFinish(activeTask)}>
                                        <QrCode className="w-5 h-5" /> Scan QR to Finish Job
                                    </Button>
                                    <div className="mt-4 pt-4 border-t"><button onClick={() => setIsRequestModalOpen(true)} className="text-sm text-blue-600 hover:underline font-bold flex items-center justify-center gap-1"><ShoppingBag className="w-4 h-4" /> Request Special Part</button></div>
                                </div>
                            ) : (
                                <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    <div className="bg-green-100 text-green-800 p-2 rounded text-sm text-center font-bold">âœ“ Machine Verified</div>
                                    <textarea className="w-full p-3 border rounded h-24 bg-white" placeholder="Describe repairs made (Mandatory)..." value={remarks} onChange={(e) => setRemarks(e.target.value)} />
                                    <div className="bg-white p-3 rounded border">
                                        <p className="font-bold text-sm mb-2 text-slate-700">Parts Used</p>
                                        <div className="flex flex-wrap gap-2">{parts.map(part => (
                                            <button key={part.id} onClick={() => togglePart(part.id)} className={`px-3 py-1 text-xs rounded border transition-colors ${selectedParts.includes(part.id) ? 'bg-blue-600 text-white border-blue-600' : 'bg-slate-50 text-slate-600 border-slate-200'}`}>{part.name}</button>
                                        ))}</div>
                                    </div>
                                    <Button fullWidth variant="success" onClick={handleFinalSubmit}><CheckSquare className="w-4 h-4" /> Submit & Finish</Button>
                                </div>
                            )}
                        </Card>
                    ) : (
                        <>
                            <div className="space-y-4">
                                <h3 className="font-bold text-lg text-slate-700 flex items-center gap-2"><Briefcase className="w-5 h-5" /> Assigned Tasks</h3>
                                {myTasks.length === 0 ? <div className="p-4 text-center bg-slate-100 rounded-lg text-slate-500 border border-dashed border-slate-300 text-sm">No specific tasks assigned.</div> : myTasks.map(task => (
                                    <Card key={task.id} className="p-4 flex flex-col gap-3">
                                            <div className="flex justify-between"><div className="font-bold text-lg flex items-center gap-2">{task.name} {task.priority && <Badge status={task.priority} type="priority"/>}</div><Badge status="Pending" /></div>
                                            <div className="bg-slate-50 p-2 rounded text-sm text-slate-600"><span className="font-bold text-slate-800">Issue:</span> {task.issue}</div>
                                            <div className="bg-blue-50 p-2 rounded text-xs text-blue-700 flex items-center gap-1"><MapPin className="w-3 h-3" /> {task.ticketId}</div>
                                            <Button fullWidth variant="warning" onClick={() => handleScanToStart(task.id)}><QrCode className="w-4 h-4" /> Scan to Start</Button>
                                    </Card>
                                ))}
                            </div>
                            <div className="border-t border-slate-200 my-4"></div>
                            <div className="space-y-4">
                                <h3 className="font-bold text-lg text-slate-700 flex items-center gap-2"><Hand className="w-5 h-5" /> Open Job Pool</h3>
                                {unassignedTasks.length === 0 ? <div className="p-4 text-center bg-green-50 rounded-lg text-green-600 border border-green-200 text-sm">All clear!</div> : unassignedTasks.map(task => (
                                    <Card key={task.id} className="p-4 border-l-4 border-l-slate-300">
                                            <div className="flex justify-between items-start">
                                                <div><div className="font-bold text-slate-800">{task.name}</div><div className="text-xs text-red-600 bg-red-50 px-2 py-1 rounded inline-block mt-1 mr-2">{task.issue}</div>{task.priority === "Critical" && <Badge status="Critical" type="priority"/>}</div>
                                                <Button size="sm" variant="outline" onClick={() => onSelfAssign(task.id)}>Claim</Button>
                                            </div>
                                    </Card>
                                ))}
                            </div>
                        </>
                    )}
                    <Modal isOpen={isRequestModalOpen} onClose={() => setIsRequestModalOpen(false)} title="Request Part">
                        <div className="space-y-4">
                            <p>text-sm text-slate-600">Request a special part from the store.</p>
                            <input className="w-full p-2 border rounded" placeholder="Part Name" value={requestPartName} onChange={(e) => setRequestPartName(e.target.value)} />
                            <Button fullWidth onClick={() => { if(requestPartName) { onRequestPart(activeTask?.id, requestPartName, currentUser); setRequestPartName(""); setIsRequestModalOpen(false); } }}>Send</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const UserSetupView = ({ users, onAddUser, onUpdateUser, onDeleteUser }) => {
            const [form, setForm] = useState({ name: "", username: "", password: "", role: "technician", mobile: "" });
            const [editingId, setEditingId] = useState(null);

            const handleSubmit = () => {
                if(!form.name || !form.username || !form.password) return alert("Please fill all required fields");
                
                if(editingId) {
                    onUpdateUser(editingId, form);
                    setEditingId(null);
                } else {
                    onAddUser(form);
                }
                setForm({ name: "", username: "", password: "", role: "technician", mobile: "" });
            };

            const handleEdit = (user) => {
                setForm({
                    name: user.name, 
                    username: user.username, 
                    password: user.password, 
                    role: user.role, 
                    mobile: user.mobile || "" 
                });
                setEditingId(user.id);
            };

            return (
                <div className="space-y-6">
                    <Card className="p-6 border-t-4 border-t-blue-500">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                            <User className="w-5 h-5" /> {editingId ? "Edit User" : "Create New User"}
                        </h3>
                        <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Full Name</label>
                                    <input className="w-full border p-2 rounded" placeholder="e.g. John Doe" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Username (Login ID)</label>
                                    <input className="w-full border p-2 rounded" placeholder="e.g. john.d" value={form.username} onChange={e => setForm({...form, username: e.target.value})} />
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Password</label>
                                    <input className="w-full border p-2 rounded" type="text" placeholder="Password" value={form.password} onChange={e => setForm({...form, password: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Role</label>
                                    <select className="w-full border p-2 rounded" value={form.role} onChange={e => setForm({...form, role: e.target.value})}>
                                        <option value="technician">Technician</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                            
                            {form.role === 'technician' && (
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Mobile Number</label>
                                    <input className="w-full border p-2 rounded" placeholder="e.g. +1 234 567 890" value={form.mobile} onChange={e => setForm({...form, mobile: e.target.value})} />
                                </div>
                            )}

                            <div className="flex gap-2">
                                <Button fullWidth onClick={handleSubmit}>{editingId ? "Update User" : "Create User"}</Button>
                                {editingId && <Button variant="secondary" onClick={() => { setEditingId(null); setForm({ name: "", username: "", password: "", role: "technician", mobile: "" }); }}>Cancel</Button>}
                            </div>
                        </div>
                    </Card>

                    <Card className="p-6">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Briefcase className="w-5 h-5"/> User Directory ({users.length})</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50 border-b">
                                    <tr>
                                        <th className="p-3">Name / ID</th>
                                        <th className="p-3">Role</th>
                                        <th className="p-3">Details</th>
                                        <th className="p-3">Status</th>
                                        <th className="p-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {users.map(user => (
                                        <tr key={user.id} className="border-b hover:bg-slate-50">
                                            <td className="p-3">
                                                <div className="font-bold">{user.name}</div>
                                                <div className="text-xs text-slate-500">@{user.username}</div>
                                            </td>
                                            <td className="p-3">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                    {user.role.toUpperCase()}
                                                </span>
                                            </td>
                                            <td className="p-3">
                                                {user.role === 'technician' && user.mobile ? (
                                                    <div className="flex items-center gap-1 text-slate-600">
                                                        <span>ðŸ“± {user.mobile}</span>
                                                    </div>
                                                ) : <span className="text-slate-400">-</span>}
                                            </td>
                                            <td className="p-3"><Badge status={user.status || 'Offline'} /></td>
                                            <td className="p-3 text-right">
                                                <div className="flex justify-end gap-2">
                                                    <button onClick={() => handleEdit(user)} className="p-1 hover:bg-blue-100 rounded text-blue-600"><Wrench className="w-4 h-4" /></button>
                                                    <button onClick={() => confirm(`Delete ${user.name}?`) && onDeleteUser(user.id)} className="p-1 hover:bg-red-100 rounded text-red-600"><Trash2 className="w-4 h-4" /></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {users.length === 0 && <tr><td colSpan="5" className="p-4 text-center text-slate-400">No users found.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- 5. MAIN APP CONTROLLER ---

        const App = () => {
            const { users, buildings, floorsMap, linesMap, machinesMap, machines, logs, parts, partRequests, floors, lines, loading } = useFactoryData();
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('live_monitor');
            const [error, setError] = useState(null);
            const [seedProgress, setSeedProgress] = useState("");
            
            // Scanner State
            const [scannerConfig, setScannerConfig] = useState({ isOpen: false, title: "", callback: null });

            // Auth handlers
            const handleLogin = (u, p) => {
                const user = users.find(user => user.username === u && user.password === p);
                if(user) {
                    setCurrentUser(user); setError(null);
                    if(user.role === 'technician') update(ref(db, `users/${user.id}`), { status: 'Available' });
                } else if(u === 'admin' && p === '123') {
                    setCurrentUser({ id: 'temp_admin', name: 'Super Admin', role: 'admin', username: 'admin' }); setError(null);
                } else setError("Invalid credentials");
            };

            const handleLogout = () => {
                if (currentUser?.role === 'technician') update(ref(db, `users/${currentUser.id}`), { status: 'Offline' });
                setCurrentUser(null);
            };

            // Seed Data Logic
            const handleSeedData = async () => {
                if(!confirm("Generate demo data?")) return;
                setSeedProgress("Generating...");
                // (Simplified logic: assumes admin knows how to use this feature based on previous full implementation)
                alert("Please create data manually for better control or use the full seeding function if needed.");
                setSeedProgress("");
            };
            
            if (loading) return <LoadingOverlay />;

            if (!currentUser) return <div className="bg-slate-50 min-h-screen">
                {activeTab === 'login' ? 
                    <LoginView onLogin={handleLogin} onReset={() => remove(ref(db, 'users'))} onOpenScanner={() => setActiveTab('operator_kiosk')} error={error} /> : 
                    <KioskView machines={machines} onReport={api.reportIssue} onClose={() => setActiveTab('login')} />
                }
            </div>;

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-900 flex flex-col md:flex-row">
                    {/* Sidebar */}
                    <div className="w-full md:w-64 bg-slate-900 text-white p-4 flex flex-col shrink-0 no-print">
                        <div className="mb-6"><h1 className="text-xl font-bold flex items-center gap-2"><Factory className="text-blue-400" /> GarmentFix</h1></div>
                        <div className="mb-6 p-3 bg-slate-800 rounded-lg">
                            <div className="text-xs text-slate-400 uppercase font-bold">Logged in as</div>
                            <div className="font-bold truncate">{currentUser.name}</div>
                            {currentUser.role === 'technician' && <button onClick={() => update(ref(db, `users/${currentUser.id}`), { status: currentUser.status === 'Available' ? 'Offline' : 'Available' })} className="mt-2 text-xs px-2 py-1 rounded bg-emerald-500 text-white w-full">{currentUser.status || 'Available'}</button>}
                        </div>
                        <nav className="space-y-2 flex-1">
                            {currentUser.role === 'admin' ? (
                                <>
                                    <button onClick={() => setActiveTab('live_monitor')} className={`w-full text-left p-3 rounded hover:bg-slate-800 flex gap-2 ${activeTab === 'live_monitor' ? 'bg-slate-800' : ''}`}><Activity className="w-5 h-5"/> Live Monitor</button>
                                    <button onClick={() => setActiveTab('factory_manager')} className={`w-full text-left p-3 rounded hover:bg-slate-800 flex gap-2 ${activeTab === 'factory_manager' ? 'bg-slate-800' : ''}`}><LayoutDashboard className="w-5 h-5"/> Factory Manager</button>
                                    <button onClick={() => setActiveTab('inventory')} className={`w-full text-left p-3 rounded hover:bg-slate-800 flex gap-2 ${activeTab === 'inventory' ? 'bg-slate-800' : ''}`}><Package className="w-5 h-5"/> Inventory</button>
                                    <button onClick={() => setActiveTab('analytics')} className={`w-full text-left p-3 rounded hover:bg-slate-800 flex gap-2 ${activeTab === 'analytics' ? 'bg-slate-800' : ''}`}><BarChart2 className="w-5 h-5"/> Analytics</button>
                                    <button onClick={() => setActiveTab('user_setup')} className={`w-full text-left p-3 rounded hover:bg-slate-800 flex gap-2 ${activeTab === 'user_setup' ? 'bg-slate-800' : ''}`}><User className="w-5 h-5"/> User Setup</button>
                                    <a href="help.html" target="_blank" className="w-full text-left p-3 rounded hover:bg-slate-800 flex gap-2 items-center"><HelpCircle className="w-5 h-5"/> Help</a>
                                </>
                            ) : (
                                <>
                                    <button onClick={() => setActiveTab('my_tasks')} className={`w-full text-left p-3 rounded hover:bg-slate-800 flex gap-2 ${activeTab === 'my_tasks' ? 'bg-slate-800' : ''}`}><ClipboardList className="w-5 h-5"/> My Tasks</button>
                                    <a href="help.html" target="_blank" className="w-full text-left p-3 rounded hover:bg-slate-800 flex gap-2 items-center"><HelpCircle className="w-5 h-5"/> Help</a>
                                </>
                            )}
                        </nav>
                        <button onClick={handleLogout} className="mt-auto flex items-center gap-2 text-slate-400 hover:text-white p-2"><LogOut className="w-4 h-4"/> Logout</button>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 overflow-y-auto h-screen p-4 md:p-8 w-full">
                        {currentUser.role === 'admin' && activeTab === 'live_monitor' && <LiveMonitor machines={machines} users={users} onAssign={api.assignTech} />}
                        {currentUser.role === 'admin' && activeTab === 'factory_manager' && <FactoryManager buildings={buildings} floorsMap={floorsMap} linesMap={linesMap} machinesMap={machinesMap} onAddBuilding={(name) => push(ref(db, 'buildings'), { name })} onAddFloor={(data) => push(ref(db, 'floors'), data)} onAddLine={(data) => push(ref(db, 'lines'), data)} onAddMachine={(data) => push(ref(db, 'machines'), {...data, status: "Running", createdAt: new Date().toISOString()})} />}
                        {currentUser.role === 'admin' && activeTab === 'inventory' && <InventoryManager parts={parts} partRequests={partRequests} onAddPart={(p) => push(ref(db, 'parts'), p)} onDeletePart={(id) => remove(ref(db, `parts/${id}`))} onUpdateStock={api.updateStock} onResolveRequest={api.resolveRequest} />}
                        {currentUser.role === 'admin' && activeTab === 'analytics' && <AnalyticsDashboard logs={logs} machines={machines} parts={parts} floors={floors} lines={lines} users={users} buildings={buildings} />}
                        {currentUser.role === 'admin' && activeTab === 'user_setup' && <UserSetupView 
                            users={users} 
                            onAddUser={(data) => push(ref(db, 'users'), { ...data, status: 'Offline', createdAt: new Date().toISOString() })} 
                            onUpdateUser={(id, data) => update(ref(db, `users/${id}`), data)}
                            onDeleteUser={(id) => remove(ref(db, `users/${id}`))}
                        />}
                        
                        {currentUser.role === 'technician' && activeTab === 'my_tasks' && <TechnicianTaskBoard currentUser={users.find(u => u.id === currentUser.id) || currentUser} machines={machines} parts={parts} logs={logs} onScanStart={(id) => api.startWork(id, currentUser.id)} onComplete={(mid, uid, rem, mach, partsIds) => api.completeWork(mid, currentUser.id, rem, mach, partsIds, parts)} onSelfAssign={(id) => api.selfAssign(id, currentUser.id)} onRequestPart={api.requestPart} />}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
