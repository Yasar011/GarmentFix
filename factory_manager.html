<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GarmentFix - Factory Manager Tool</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ADDED: QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
      }
    }
    </script>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          LayoutDashboard, PlusCircle, Factory, Printer, QrCode, 
          Building, Trash2, Loader2, LogOut, Wrench, AlertTriangle, 
          CheckCircle, Settings, Layers, Zap, ChevronDown, ChevronRight, 
          AlertCircle, Lock, Unlock, ShieldAlert, Calendar, Edit3, ScanLine, X, Search, History
        } from 'lucide-react';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously } from "firebase/auth";
        import { getDatabase, ref, push, onValue, remove, update } from "firebase/database";

        // --- SHARED CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyBUbE6WtnWnHQsCul_5bDDPHz78jlaHCxs",
          authDomain: "apparel-maintenance.firebaseapp.com",
          databaseURL: "https://apparel-maintenance-default-rtdb.firebaseio.com",
          projectId: "apparel-maintenance",
          storageBucket: "apparel-maintenance.firebasestorage.app",
          messagingSenderId: "716246308986",
          appId: "1:716246308986:web:0f5f33db9c65ffba1543c3",
          measurementId: "G-4G0694Q22Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- COMPONENTS ---
        const Card = ({ children, className = "" }) => (
          <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>
        );

        const Button = ({ onClick, children, className = "", variant="primary", disabled=false }) => {
            const styles = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700",
                secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-200",
                warning: "bg-orange-500 text-white hover:bg-orange-600",
                dark: "bg-slate-800 text-white hover:bg-slate-900"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`px-4 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${styles[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}>
                    {children}
                </button>
            );
        };

        const StatCard = ({ label, value, icon: Icon, color }) => (
            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p className="text-slate-500 text-xs font-bold uppercase">{label}</p>
                    <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
                </div>
                <div className={`p-3 rounded-full bg-${color}-50`}>
                    <Icon className={`w-6 h-6 text-${color}-500`} />
                </div>
            </div>
        );

        const AuthModal = ({ isOpen, onClose, onConfirm, error }) => {
            const [u, setU] = useState("");
            const [p, setP] = useState("");
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <Card className="w-full max-w-sm p-6 animate-in zoom-in-95 duration-200">
                        <div className="text-center mb-6">
                            <div className="bg-indigo-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2"><Lock className="w-6 h-6 text-indigo-600"/></div>
                            <h3 className="font-bold text-lg text-slate-800">Admin Locked</h3>
                            <p className="text-sm text-slate-500">Enter credentials to Edit & Delete.</p>
                        </div>
                        {error && <div className="bg-red-50 text-red-600 p-2 text-sm rounded mb-4 text-center border border-red-200">{error}</div>}
                        <div className="space-y-3">
                            <input className="w-full p-2 border rounded" placeholder="Admin Username" value={u} onChange={e=>setU(e.target.value)} autoFocus />
                            <input className="w-full p-2 border rounded" type="password" placeholder="Password" value={p} onChange={e=>setP(e.target.value)} />
                            <div className="flex gap-2 pt-2">
                                <Button variant="secondary" className="flex-1" onClick={onClose}>Cancel</Button>
                                <Button variant="primary" className="flex-1" onClick={() => onConfirm(u, p)}>Unlock</Button>
                            </div>
                        </div>
                    </Card>
                </div>
            )
        }

        const MachineDetailsModal = ({ machine, logs, onClose }) => {
            if (!machine) return null;

            // Calculate PM Status
            const lastPM = machine.lastMaintenance ? new Date(machine.lastMaintenance) : null;
            const daysSincePM = lastPM ? Math.floor((new Date() - lastPM) / (1000 * 60 * 60 * 24)) : 999;
            const isPmValid = daysSincePM <= 30;
            const pmStatus = isPmValid ? "Valid" : "Expired / Due";
            
            // Filter logs
            const history = logs.filter(l => l.machineId === machine.id).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            return (
                 <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh] animate-in zoom-in-95 duration-200 shadow-2xl">
                        <div className="p-4 bg-slate-900 text-white flex justify-between items-center shrink-0">
                             <h3 className="font-bold text-lg flex items-center gap-2"><Factory className="w-5 h-5 text-indigo-400"/> Machine Details</h3>
                             <button onClick={onClose}><X className="w-6 h-6 text-slate-400 hover:text-white"/></button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto space-y-6">
                            
                            <div className="text-center">
                                <h2 className="text-2xl font-bold text-slate-900">{machine.name}</h2>
                                <p className="text-slate-500 text-sm font-mono mt-1">ID: {machine.id}</p>
                            </div>

                            {/* Status Cards */}
                            <div className="grid grid-cols-2 gap-4">
                                <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                    <div className="text-xs text-slate-500 font-bold uppercase mb-1">Current Status</div>
                                    <div className={`font-bold text-lg ${machine.status === 'Running' ? 'text-green-600' : 'text-red-600'}`}>{machine.status}</div>
                                    {machine.year && <div className="text-xs text-slate-400 mt-1">Est. {machine.year}</div>}
                                </div>
                                <div className={`p-4 rounded-xl border ${isPmValid ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                    <div className={`text-xs font-bold uppercase mb-1 ${isPmValid ? 'text-green-600' : 'text-red-600'}`}>PM Status</div>
                                    <div className={`font-bold text-lg ${isPmValid ? 'text-green-800' : 'text-red-800'}`}>{pmStatus}</div>
                                    <div className="text-[11px] opacity-75 mt-1">{lastPM ? `Last: ${lastPM.toLocaleDateString()}` : "Never serviced"}</div>
                                </div>
                            </div>

                            {/* History */}
                            <div>
                                <div className="flex items-center justify-between mb-3 border-b pb-2">
                                    <h4 className="font-bold text-slate-800 flex items-center gap-2"><History className="w-4 h-4 text-indigo-600"/> Maintenance History</h4>
                                    <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">{history.length} Records</span>
                                </div>
                                
                                <div className="space-y-3">
                                    {history.length > 0 ? history.map(log => (
                                        <div key={log.id} className="text-sm p-3 bg-slate-50 rounded border border-slate-100 hover:bg-white hover:shadow-sm transition-all">
                                            <div className="flex justify-between text-xs text-slate-500 mb-1">
                                                <span>{new Date(log.timestamp).toLocaleDateString()}</span>
                                                <span className="font-mono font-bold text-slate-700">{log.action}</span>
                                            </div>
                                            <div className="text-slate-800 font-medium">{log.details || "No details provided."}</div>
                                            {log.repairTime && <div className="text-xs text-indigo-500 mt-1">Duration: {log.repairTime}</div>}
                                        </div>
                                    )) : <div className="text-center py-4 text-slate-400 italic text-sm border border-dashed rounded">No repair history found.</div>}
                                </div>
                            </div>

                        </div>
                        
                        <div className="p-4 border-t bg-slate-50 flex justify-end">
                             <Button onClick={onClose} variant="secondary">Close</Button>
                        </div>
                    </div>
                 </div>
            )
        }

        // --- NEW: QR SCANNER COMPONENT ---
        const QRScanner = ({ onScan, onClose, title }) => {
            useEffect(() => {
                const onScanSuccess = (decodedText) => {
                    html5QrcodeScanner.clear().then(() => {
                        onScan(decodedText);
                    }).catch(err => console.error("Failed to clear scanner", err));
                };

                const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
                html5QrcodeScanner.render(onScanSuccess, (error) => {});

                return () => { try { html5QrcodeScanner.clear(); } catch(e) {} };
            }, [onScan]);

            return (
                <div className="fixed inset-0 bg-black/90 z-[100] flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-xl w-full max-w-md overflow-hidden relative">
                        <div className="p-3 bg-slate-900 text-white flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2"><ScanLine className="w-5 h-5"/> {title || "Scan QR Code"}</h3>
                            <button onClick={onClose}><X className="w-5 h-5"/></button>
                        </div>
                        <div className="p-4 bg-black"><div id="reader" className="w-full"></div></div>
                        <div className="p-4 text-center text-sm text-slate-500">Point camera at machine QR code</div>
                    </div>
                </div>
            );
        };

        // --- DATA HOOK ---
        const useFactoryData = () => {
            const [data, setData] = useState({ buildings: [], floors: [], lines: [], machines: [], users: [], logs: [] });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                const endpoints = ['buildings', 'floors', 'lines', 'machines', 'users', 'logs'];
                const unsubscribers = endpoints.map(endpoint => {
                    return onValue(ref(db, endpoint), (snapshot) => {
                        const val = snapshot.val();
                        const list = val ? Object.keys(val).map(key => ({id: key, ...val[key]})) : [];
                        setData(prev => ({ ...prev, [endpoint]: list }));
                        if(endpoint === 'machines') setLoading(false);
                    });
                });
                return () => unsubscribers.forEach(unsub => unsub());
            }, []);

            const maps = useMemo(() => ({
                floorsMap: data.floors.reduce((acc, f) => { (acc[f.buildingId] = acc[f.buildingId] || []).push(f); return acc; }, {}),
                linesMap: data.lines.reduce((acc, l) => { (acc[l.floorId] = acc[l.floorId] || []).push(l); return acc; }, {}),
                machinesMap: data.machines.reduce((acc, m) => { (acc[m.lineId] = acc[m.lineId] || []).push(m); return acc; }, {})
            }), [data.floors, data.lines, data.machines]);

            return { ...data, ...maps, loading };
        };

        // --- QR PRINT FUNCTION ---
        const handlePrintQRs = (title, machinesList) => {
            if(!machinesList || machinesList.length === 0) return alert("No machines found to print.");
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>QR Codes - ${title}</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        .grid { display: grid; grid-template-columns: repeat(auto-fill, 160px); gap: 15px; justify-content: center; }
                        .card { border: 2px solid #000; padding: 10px; text-align: center; page-break-inside: avoid; border-radius: 8px; width: 160px; height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
                        img { width: 100px; height: 100px; object-fit: contain; }
                        .name { font-weight: bold; font-size: 14px; margin-top: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
                        .id { font-size: 12px; color: #333; font-family: monospace; }
                        .meta { font-size: 10px; color: #666; margin-top: 5px; }
                        @media print { .no-print { display: none; } body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="text-align:center; margin-bottom:20px;">
                        <h1>${title}</h1>
                        <button onclick="window.print()" style="padding:10px 20px; background:#2563eb; color:white; border:none; border-radius:5px; cursor:pointer;">Print Labels</button>
                    </div>
                    <div class="grid">
                        ${machinesList.map(m => `
                            <div class="card">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${m.id}" alt="${m.name}" />
                                <div class="name">${m.name}</div>
                                <div class="id">${m.id}</div>
                                ${m.year ? `<div class="meta">Est. ${m.year}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // --- MAIN MANAGER COMPONENT ---
        const FactoryManagerApp = () => {
            const { buildings, floors, lines, machines, users, logs, floorsMap, linesMap, machinesMap, loading } = useFactoryData();
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [expandedBuildings, setExpandedBuildings] = useState({});
            const [highlightedMachine, setHighlightedMachine] = useState(null);
            
            // ADMIN MODE State
            const [adminMode, setAdminMode] = useState(false);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [authError, setAuthError] = useState("");
            const [showScanner, setShowScanner] = useState(false);
            const [scannedMachineDetails, setScannedMachineDetails] = useState(null);

            // Form States
            const [newBuilding, setNewBuilding] = useState("");
            const [newFloor, setNewFloor] = useState({ name: "", buildingId: "" });
            const [newLine, setNewLine] = useState({ name: "", floorId: "" });
            const [newMachine, setNewMachine] = useState({ name: "", year: "", lineId: "" });

            // Initialize expanded state
            useEffect(() => {
                if(buildings.length > 0 && Object.keys(expandedBuildings).length === 0) {
                    const initial = {};
                    buildings.forEach(b => initial[b.id] = true);
                    setExpandedBuildings(initial);
                }
            }, [buildings]);

            const brokenMachines = machines.filter(m => m.status === 'Pending' || m.status === 'In Progress');
            const brokenCount = brokenMachines.length;

            const toggleBuilding = (id) => setExpandedBuildings(prev => ({...prev, [id]: !prev[id]}));

            // Actions
            const onAddBuilding = () => { if(newBuilding) { push(ref(db, 'buildings'), { name: newBuilding }); setNewBuilding(""); }};
            const onAddFloor = () => { if(newFloor.name && newFloor.buildingId) { push(ref(db, 'floors'), newFloor); setNewFloor({name: "", buildingId: ""}); }};
            const onAddLine = () => { if(newLine.name && newLine.floorId) { push(ref(db, 'lines'), newLine); setNewLine({name: "", floorId: ""}); }};
            const onAddMachine = () => { 
                if(newMachine.name && newMachine.lineId) {
                    push(ref(db, 'machines'), {...newMachine, status: "Running", createdAt: new Date().toISOString()}); 
                    setNewMachine({name: "", year: "", lineId: ""}); 
                }
            };

            const getMachinesForFloor = (fId) => (linesMap[fId] || []).flatMap(l => machinesMap[l.id] || []);
            const getMachinesForBuilding = (bId) => (floorsMap[bId] || []).flatMap(f => getMachinesForFloor(f.id));

            // Unified Auth Helper
            const checkCredentials = (u, p) => {
                const adminUser = users.find(user => user.username === u && user.password === p && user.role === 'admin');
                const isHardcodedAdmin = (u === 'admin' && p === '123');
                return adminUser || isHardcodedAdmin;
            };

            // Authenticated Action Unlock
            const handleAuthSubmit = (u, p) => {
                if (checkCredentials(u, p)) {
                    setAdminMode(true);
                    setShowAuthModal(false);
                    setAuthError("");
                } else {
                    setAuthError("Invalid credentials or not an Admin.");
                }
            };

            // DELETE HANDLERS
            const handleDelete = (e, path, name) => {
                e.stopPropagation(); 
                e.preventDefault();

                if(!adminMode) return alert("Please unlock Edit Mode first.");
                
                if(confirm(`⚠️ DELETE WARNING\n\nAre you sure you want to delete: ${name}?\nThis action cannot be undone.`)) {
                    remove(ref(db, path))
                        .catch(err => alert("Firebase Delete Error: " + err.message));
                }
            };

            // SCAN TO FIND HANDLER
            const handleScanFind = (data) => {
                // Find machine by ID or Name
                const machine = machines.find(m => m.id === data || m.name === data);
                
                if (machine) {
                    // Find hierarchy
                    const line = lines.find(l => l.id === machine.lineId);
                    const floor = floors.find(f => f.id === line?.floorId);
                    const building = buildings.find(b => b.id === floor?.buildingId);
                    
                    if (building) {
                        // Auto-Expand the building
                        setExpandedBuildings(prev => ({ ...prev, [building.id]: true }));
                        setHighlightedMachine(machine.id);
                        
                        // OPEN DETAILS MODAL
                        setScannedMachineDetails(machine);
                        
                        setShowScanner(false);
                        
                        // Scroll to element after delay
                        setTimeout(() => {
                            const element = document.getElementById(`machine-${machine.id}`);
                            if(element) element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 500);

                        // Clear highlight after 5 seconds
                        setTimeout(() => setHighlightedMachine(null), 5000);
                    }
                } else {
                    alert("Machine not found in directory.");
                    setShowScanner(false);
                }
            };

            // --- LOGIN SCREEN ---
            const [initialCreds, setInitialCreds] = useState({u: '', p: ''});
            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                        <Card className="w-full max-w-md p-8">
                            <div className="text-center mb-8">
                                <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Factory className="w-8 h-8 text-indigo-600" /></div>
                                <h1 className="text-2xl font-bold text-slate-800">Factory Manager</h1>
                                <p className="text-slate-500">Admin Configuration Tool</p>
                            </div>
                            <form onSubmit={(e) => { e.preventDefault(); if(checkCredentials(initialCreds.u, initialCreds.p)) setIsAuthenticated(true); else alert("Invalid credentials."); }} className="space-y-4">
                                <input className="w-full p-3 border rounded-lg" placeholder="Username" value={initialCreds.u} onChange={e => setInitialCreds({...initialCreds, u: e.target.value})} />
                                <input className="w-full p-3 border rounded-lg" type="password" placeholder="Password" value={initialCreds.p} onChange={e => setInitialCreds({...initialCreds, p: e.target.value})} />
                                <Button className="w-full">Access Tool</Button>
                            </form>
                        </Card>
                    </div>
                );
            }

            if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="w-10 h-10 animate-spin text-indigo-600" /></div>;

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <AuthModal isOpen={showAuthModal} onClose={() => { setShowAuthModal(false); setAuthError(""); }} onConfirm={handleAuthSubmit} error={authError} />
                    <MachineDetailsModal machine={scannedMachineDetails} logs={logs} onClose={() => setScannedMachineDetails(null)} />
                    {showScanner && <QRScanner onScan={handleScanFind} onClose={() => setShowScanner(false)} title="Scan to Find Machine" />}

                    {/* --- SIDEBAR FORMS (HIDDEN UNLESS UNLOCKED) --- */}
                    {adminMode && (
                        <div className="w-full md:w-80 bg-white border-r border-slate-200 h-auto md:h-screen md:sticky md:top-0 md:overflow-y-auto flex-shrink-0 flex flex-col animate-in slide-in-from-left-10 duration-300">
                            <div className="p-4 bg-slate-900 text-white flex justify-between items-center sticky top-0 z-10 shrink-0">
                                 <h1 className="font-bold flex items-center gap-2"><Settings className="w-5 h-5" /> Setup Console</h1>
                            </div>
                            
                            <div className="p-4 space-y-6 flex-1 overflow-y-auto">
                                <div className="bg-indigo-50 border border-indigo-100 p-3 rounded text-xs text-indigo-800 mb-4 flex items-center gap-2">
                                    <Edit3 className="w-4 h-4" /> Mode: Editing Enabled
                                </div>

                                <div className="space-y-3">
                                    <h3 className="font-bold text-sm text-slate-500 uppercase flex items-center gap-2"><Building className="w-4 h-4"/> 1. Add Building</h3>
                                    <input className="w-full p-2 text-sm border rounded bg-slate-50" placeholder="Building Name" value={newBuilding} onChange={e => setNewBuilding(e.target.value)} />
                                    <Button onClick={onAddBuilding} className="w-full py-1 text-sm">Create Building</Button>
                                </div>
                                <div className="border-t"></div>

                                <div className="space-y-3">
                                    <h3 className="font-bold text-sm text-slate-500 uppercase flex items-center gap-2"><Layers className="w-4 h-4"/> 2. Add Floor</h3>
                                    <select className="w-full p-2 text-sm border rounded bg-slate-50" value={newFloor.buildingId} onChange={e => setNewFloor({...newFloor, buildingId: e.target.value})}>
                                        <option value="">Select Building...</option>
                                        {buildings.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                    </select>
                                    <input className="w-full p-2 text-sm border rounded bg-slate-50" placeholder="Floor Name" value={newFloor.name} onChange={e => setNewFloor({...newFloor, name: e.target.value})} />
                                    <Button onClick={onAddFloor} className="w-full py-1 text-sm">Create Floor</Button>
                                </div>
                                <div className="border-t"></div>

                                <div className="space-y-3">
                                    <h3 className="font-bold text-sm text-slate-500 uppercase flex items-center gap-2"><Zap className="w-4 h-4"/> 3. Add Line</h3>
                                    <select className="w-full p-2 text-sm border rounded bg-slate-50" value={newLine.floorId} onChange={e => setNewLine({...newLine, floorId: e.target.value})}>
                                        <option value="">Select Floor...</option>
                                        {Object.keys(floorsMap).map(bId => (
                                            <optgroup key={bId} label={buildings.find(b=>b.id===bId)?.name}>
                                                {floorsMap[bId].map(f => <option key={f.id} value={f.id}>{f.name}</option>)}
                                            </optgroup>
                                        ))}
                                    </select>
                                    <input className="w-full p-2 text-sm border rounded bg-slate-50" placeholder="Line Name" value={newLine.name} onChange={e => setNewLine({...newLine, name: e.target.value})} />
                                    <Button onClick={onAddLine} className="w-full py-1 text-sm">Create Line</Button>
                                </div>
                                <div className="border-t"></div>

                                <div className="space-y-3">
                                    <h3 className="font-bold text-sm text-slate-500 uppercase flex items-center gap-2"><Factory className="w-4 h-4"/> 4. Add Machine</h3>
                                    <select className="w-full p-2 text-sm border rounded bg-slate-50" value={newMachine.lineId} onChange={e => setNewMachine({...newMachine, lineId: e.target.value})}>
                                        <option value="">Select Line...</option>
                                        {Object.keys(linesMap).map(fId => (
                                            <optgroup key={fId} label={floors.find(f => f.id === fId)?.name || 'Unknown Floor'}>
                                                {linesMap[fId].map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                                            </optgroup>
                                        ))}
                                    </select>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="w-full p-2 text-sm border rounded bg-slate-50" placeholder="Machine Name" value={newMachine.name} onChange={e => setNewMachine({...newMachine, name: e.target.value})} />
                                        <input type="number" className="w-full p-2 text-sm border rounded bg-slate-50" placeholder="Year (e.g 2023)" value={newMachine.year} onChange={e => setNewMachine({...newMachine, year: e.target.value})} />
                                    </div>
                                    <Button onClick={onAddMachine} className="w-full py-1 text-sm">Create Machine</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MAIN CONTENT --- */}
                    <div className="flex-1 bg-slate-100 h-screen overflow-y-auto">
                        <div className="p-8 max-w-7xl mx-auto space-y-8">
                            
                            {/* 1. Stats Directory */}
                            <div>
                                <div className="flex justify-between items-end mb-4 flex-wrap gap-4">
                                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><LayoutDashboard className="text-indigo-600"/> Factory Directory</h2>
                                    
                                    <div className="flex items-center gap-3">
                                        {/* SCANNER BUTTON */}
                                        <button 
                                            onClick={() => setShowScanner(true)} 
                                            className="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-slate-50 shadow-sm"
                                        >
                                            <ScanLine className="w-4 h-4" /> Scan Machine
                                        </button>

                                        {/* ADMIN UNLOCK BUTTON */}
                                        {!adminMode ? (
                                            <button 
                                                onClick={() => setShowAuthModal(true)} 
                                                className="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-slate-50 shadow-sm"
                                            >
                                                <Lock className="w-4 h-4" /> Unlock Edit Mode
                                            </button>
                                        ) : (
                                            <button 
                                                onClick={() => setAdminMode(false)} 
                                                className="bg-indigo-100 text-indigo-700 border border-indigo-200 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-indigo-200 shadow-inner"
                                            >
                                                <Unlock className="w-4 h-4" /> Lock Console
                                            </button>
                                        )}

                                        <button onClick={() => setIsAuthenticated(false)} className="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-slate-300">
                                            <LogOut className="w-4 h-4"/> Logout
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <StatCard label="Plants" value={buildings.length} icon={Building} color="indigo" />
                                    <StatCard label="Floors" value={floors.length} icon={Layers} color="blue" />
                                    <StatCard label="Lines" value={lines.length} icon={Zap} color="purple" />
                                    <StatCard label="Machines" value={machines.length} icon={Factory} color="slate" />
                                    <StatCard label="Breakdowns" value={brokenCount} icon={AlertTriangle} color="red" />
                                </div>
                            </div>

                            {/* 2. ACTIVE BREAKDOWNS */}
                            {brokenCount > 0 && (
                                <div className="animate-fade-in">
                                    <h3 className="text-xl font-bold text-red-700 mb-4 flex items-center gap-2">
                                        <AlertCircle className="w-6 h-6" /> Active Breakdowns ({brokenCount})
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {brokenMachines.map(m => (
                                            <div key={m.id} className="bg-red-50 border border-red-200 p-4 rounded-xl flex justify-between items-start shadow-sm">
                                                <div>
                                                    <div className="font-bold text-red-900">{m.name}</div>
                                                    <div className="text-xs text-red-700 font-mono mt-1">{m.ticketId}</div>
                                                    <div className="text-sm text-red-800 mt-2">{m.issue}</div>
                                                </div>
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${m.status === 'Pending' ? 'bg-red-200 text-red-800' : 'bg-yellow-200 text-yellow-800'}`}>
                                                    {m.status}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* 3. Facility Overview */}
                            <div>
                                <h3 className="text-xl font-bold text-slate-800 mb-4">Facility Overview</h3>
                                <div className="space-y-4">
                                    {buildings.length === 0 && <div className="p-8 text-center text-slate-400 bg-white rounded-xl border border-dashed">Start by unlocking Edit Mode and adding a building.</div>}
                                    
                                    {buildings.map(b => (
                                        <div key={b.id} className={`border rounded-xl bg-white shadow-sm overflow-hidden transition-all ${adminMode ? 'border-indigo-200 ring-2 ring-indigo-50' : 'border-slate-200'}`}>
                                            {/* Header */}
                                            <div 
                                                className="flex justify-between items-center p-4 bg-white cursor-pointer hover:bg-slate-50"
                                                onClick={() => toggleBuilding(b.id)}
                                            >
                                                <div className="flex items-center gap-3">
                                                    {expandedBuildings[b.id] ? <ChevronDown className="w-5 h-5 text-slate-400"/> : <ChevronRight className="w-5 h-5 text-slate-400"/>}
                                                    <h4 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Building className="w-5 h-5 text-indigo-600" /> {b.name}</h4>
                                                    <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">{(floorsMap[b.id] || []).length} Floors</span>
                                                </div>
                                                <div className="flex items-center gap-2" onClick={(e) => e.stopPropagation()}>
                                                    <Button variant="secondary" onClick={() => handlePrintQRs(b.name, getMachinesForBuilding(b.id))} className="text-xs py-1 h-8"><Printer className="w-3 h-3"/> Plant QRs</Button>
                                                    {adminMode && (
                                                        <button onClick={(e) => handleDelete(e, `buildings/${b.id}`, b.name)} className="p-2 bg-red-50 text-red-500 hover:text-white hover:bg-red-600 rounded border border-red-200 shadow-sm" title="Delete Building"><Trash2 className="w-4 h-4"/></button>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Body */}
                                            {expandedBuildings[b.id] && (
                                                <div className="p-6 border-t border-slate-100 bg-slate-50/50 space-y-6 animate-in slide-in-from-top-2 duration-200">
                                                    {(floorsMap[b.id] || []).length === 0 && <p className="text-sm text-slate-400 italic pl-8">No floors added yet.</p>}
                                                    
                                                    {(floorsMap[b.id] || []).map(floor => (
                                                        <div key={floor.id} className="bg-white border border-slate-200 p-4 rounded-xl shadow-sm">
                                                            <div className="flex items-center justify-between mb-4">
                                                                <h5 className="font-bold text-md text-slate-700 flex items-center gap-2"><Layers className="w-4 h-4 text-slate-400" /> {floor.name}</h5>
                                                                <div className="flex items-center gap-2">
                                                                    <button onClick={() => handlePrintQRs(`${b.name} - ${floor.name}`, getMachinesForFloor(floor.id))} className="text-xs text-indigo-600 hover:underline">Print Floor QRs</button>
                                                                    {adminMode && <button onClick={(e) => handleDelete(e, `floors/${floor.id}`, floor.name)} className="text-red-300 hover:text-red-600 ml-2" title="Delete Floor"><Trash2 className="w-4 h-4"/></button>}
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                                                {(linesMap[floor.id] || []).map(line => (
                                                                    <div key={line.id} className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                                                        <div className="flex justify-between items-center mb-3">
                                                                            <h5 className="font-bold text-slate-800 text-sm">{line.name}</h5>
                                                                            <div className="flex items-center gap-1">
                                                                                <button onClick={() => handlePrintQRs(`${floor.name} - ${line.name}`, machinesMap[line.id] || [])} className="p-1 hover:bg-slate-200 rounded"><Printer className="w-3 h-3 text-slate-400"/></button>
                                                                                {adminMode && <button onClick={(e) => handleDelete(e, `lines/${line.id}`, line.name)} className="p-1 hover:bg-red-50 rounded text-red-300 hover:text-red-600" title="Delete Line"><Trash2 className="w-3 h-3"/></button>}
                                                                            </div>
                                                                        </div>
                                                                        <div className="space-y-1 max-h-48 overflow-y-auto">
                                                                            {(machinesMap[line.id] || []).map(machine => (
                                                                                <div 
                                                                                    key={machine.id} 
                                                                                    id={`machine-${machine.id}`}
                                                                                    className={`flex justify-between items-center p-2 rounded border text-xs shadow-sm transition-all duration-500 ${highlightedMachine === machine.id ? 'bg-yellow-100 border-yellow-400 ring-2 ring-yellow-300' : 'bg-white border-slate-100 hover:border-indigo-200'}`}
                                                                                >
                                                                                    <div>
                                                                                        <div className="flex items-center gap-2 truncate">
                                                                                            <div className={`w-2 h-2 rounded-full flex-shrink-0 ${machine.status === 'Running' ? 'bg-green-500' : machine.status === 'Pending' ? 'bg-red-500 animate-pulse' : 'bg-yellow-500'}`} title={machine.status}></div>
                                                                                            <span className="font-medium truncate text-slate-700">{machine.name}</span>
                                                                                        </div>
                                                                                        {machine.year && <div className="text-[10px] text-slate-400 ml-4">Est. {machine.year}</div>}
                                                                                    </div>
                                                                                    <div className="flex items-center gap-1">
                                                                                        <button onClick={() => handlePrintQRs(machine.name, [machine])} title="Print QR" className="text-slate-300 hover:text-indigo-600"><QrCode className="w-3 h-3"/></button>
                                                                                        {adminMode && <button onClick={(e) => handleDelete(e, `machines/${machine.id}`, machine.name)} className="text-red-300 hover:text-red-600" title="Delete Machine"><Trash2 className="w-3 h-3"/></button>}
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                            {(machinesMap[line.id] || []).length === 0 && <p className="text-xs text-slate-400 italic">Empty line.</p>}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                            {(linesMap[floor.id] || []).length === 0 && <p className="text-sm text-slate-400 italic">No lines on this floor.</p>}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<FactoryManagerApp />);
    </script>
</body>
</html>
